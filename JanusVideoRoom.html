<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Janus Video Room</title>
    <style>
        #status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        video {
            border: 1px solid #ccc;
            background-color: #000;
            width: 320px;
            height: 240px;
            margin: 10px;
        }
        #remoteVideos {
            display: flex;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <h1>Janus Video Room</h1>
    <div id="status">Status: Not connected</div>
    <video id="localVideo" autoplay muted></video>
    <div id="remoteVideos"></div>
    <br />
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>
    <button id="showPublishers">Show Publishers</button>
    <button id="showSubscribers">Show Subscribers</button>
    <div id="publisherList"></div>
    <div id="subscriberList"></div>

    <!-- Include WebRTC adapter -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
    <script src="janus.js"></script>
    <script>
        let janus = null;
        let videoRoomPlugin = null;
        let opaqueId = "videoroomtest-" + Janus.randomString(12);
        let myRoom = 1234; // Room ID
        const currentWebsocketURL = "ws://125.212.229.11:8188/ws"; // Your Janus server URL
        let myId = null;
        let subscribers = []; // Store list of subscriber handles

        function updateStatus(message) {
            document.getElementById("status").innerText = "Status: " + message;
        }

        Janus.init({
            debug: "all",
            callback: function() {
                janus = new Janus({
                    server: currentWebsocketURL,
                    success: function() {
                        janus.attach({
                            plugin: "janus.plugin.videoroom",
                            opaqueId: opaqueId,
                            success: function(pluginHandle) {
                                videoRoomPlugin = pluginHandle;
                                updateStatus("Plugin attached. Ready to create or join a room.");
                            },
                            error: function(error) {
                                console.error("Error attaching plugin...", error);
                                updateStatus("Error attaching plugin.");
                            },
                            onmessage: function(msg, jsep) {
                                var event = msg["videoroom"];
                                if (event) {
                                    if (event === "joined") {
                                        myId = msg["id"];
                                        updateStatus("Successfully joined the room. Publishing...");
                                        publishOwnFeed();

                                        // Subscribe to existing publishers
                                        if (msg["publishers"]) {
                                            console.log("hit joined publishers: ", msg)
                                            let list = msg["publishers"];
                                            for (let f in list) {
                                                let id = list[f]["id"];
                                                let display = list[f]["display"];
                                                newRemoteFeed(id, display);
                                            }
                                        }
                                    } else if (event === "event") {
                                        // Handle new publishers joining after you
                                        if (msg["publishers"]) {
                                            console.log("hit event: ", msg)
                                            let list = msg["publishers"];
                                            for (let f in list) {
                                                let id = list[f]["id"];
                                                let display = list[f]["display"];
                                                newRemoteFeed(id, display);
                                            }
                                        }
                                    }
                                }
                                if (jsep) {
                                    videoRoomPlugin.handleRemoteJsep({ jsep: jsep });
                                }
                            },
                            onlocalstream: function(stream) {
                                Janus.attachMediaStream(document.getElementById("localVideo"), stream);
                                updateStatus("Local stream started.");
                            },
                            onremotestream: function(stream) {
                                // This will be handled by newRemoteFeed for each participant
                            },
                            oncleanup: function() {
                                console.log("Cleanup done.");
                                updateStatus("Cleanup done.");
                            }
                        });
                    },
                    error: function(error) {
                        console.error("Error connecting to Janus:", error);
                        updateStatus("Error connecting to Janus.");
                    }
                });
            }
        });

        function publishOwnFeed() {
            videoRoomPlugin.createOffer({
                media: { audio: true, video: true },
                success: function(jsep) {
                    let publish = { request: "publish", audio: true, video: true };
                    videoRoomPlugin.send({ message: publish, jsep: jsep });
                },
                error: function(error) {
                    console.error("WebRTC error:", error);
                    updateStatus("WebRTC error.");
                }
            });
        }

        function newRemoteFeed(id, display) {
            let remoteFeed = null;
            janus.attach({
                plugin: "janus.plugin.videoroom",
                opaqueId: opaqueId,
                success: function(pluginHandle) {
                    remoteFeed = pluginHandle;
                    subscribers.push(remoteFeed);
                    let subscribe = {
                        request: "join",
                        room: myRoom,
                        ptype: "subscriber",
                        streams: [
                            {
                                feed: id,
                            },
                        // Other streams to subscribe to
                        ]
                    };
                    remoteFeed.send({ message: subscribe });
                },
                onmessage: function(msg, jsep) {
                    if (jsep) {
                        remoteFeed.createAnswer({
                            jsep: jsep,
                            media: { audioSend: false, videoSend: false },
                            success: function(jsep) {
                                let body = { request: "start", room: myRoom };
                                remoteFeed.send({ message: body, jsep: jsep });
                            },
                            error: function(error) {
                                console.error("WebRTC error:", error);
                                updateStatus("WebRTC error.");
                            }
                        });
                    }
                },
                onremotestream: function(stream) {
                    let remoteVideo = document.createElement("video");
                    remoteVideo.autoplay = true;
                    remoteVideo.id = "remoteVideo" + id;
                    remoteVideo.style.width = "320px";
                    remoteVideo.style.height = "240px";
                    document.getElementById("remoteVideos").appendChild(remoteVideo);
                    Janus.attachMediaStream(remoteVideo, stream);
                    updateStatus("Remote stream received from " + display);
                },
                oncleanup: function() {
                    console.log("Cleanup done for remote feed " + id);
                }
            });
        }

        document.getElementById("createRoom").addEventListener("click", function() {
            let create = { request: "create", room: myRoom, publishers: 6 };
            videoRoomPlugin.send({
                message: create,
                success: function(result) {
                    updateStatus("Room created with ID: " + result.room);
                }
            });
        });

        document.getElementById("joinRoom").addEventListener("click", function() {
            let join = { request: "join", room: myRoom, ptype: "publisher", display: "User-" + Janus.randomString(4) };
            videoRoomPlugin.send({ message: join });
        });

        document.getElementById("showPublishers").addEventListener("click", function() {
            videoRoomPlugin.send({
                message: { request: "listparticipants", room: myRoom },
                success: function(result) {
                    let participants = result.participants;
                    let publisherList = participants.filter(p => p.publisher);
                    document.getElementById("publisherList").innerHTML = "<h3>Publishers:</h3><ul>" +
                        publisherList.map(p => "<li>" + p.display + " (ID: " + p.id + ")</li>").join('') +
                        "</ul>";
                }
            });
        });

        document.getElementById("showSubscribers").addEventListener("click", function() {
            document.getElementById("subscriberList").innerHTML = "<h3>Subscribers:</h3><ul>" +
                subscribers.map(s => "<li>ID: " + s.getId() + "</li>").join('') +
                "</ul>";
        });
    </script>
</body>
</html>
