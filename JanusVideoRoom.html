<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Janus Video Room</title>
    <style>
        #status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        video {
            border: 1px solid #ccc;
            background-color: #000;
            width: 320px;
            height: 240px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Janus Video Room</h1>
    <div id="status">Status: Not connected</div>
    <video id="localVideo" autoplay muted></video>
    <div id="remoteVideos"></div>
    <br />
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>

    <!-- Using the specified WebRTC adapter -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
    <script src="janus.js"></script>
    <script>
        var janus = null;
        var videoRoomPlugin = null;
        var opaqueId = "videoroomtest-" + Janus.randomString(12);
        var myRoom = 8734873473; // You can change this room ID
        var isPublisher = false;
        const currentWebsocketURL = "ws://125.212.229.11:8188/ws"; // Your Janus server URL

        function updateStatus(message) {
            document.getElementById("status").innerText = "Status: " + message;
        }

        Janus.init({
            debug: "all",
            callback: function() {
                janus = new Janus({
                    server: currentWebsocketURL,
                    success: function() {
                        janus.attach({
                            plugin: "janus.plugin.videoroom",
                            opaqueId: opaqueId,
                            success: function(pluginHandle) {
                                videoRoomPlugin = pluginHandle;
                                updateStatus("Plugin attached. Ready to create or join a room.");
                            },
                            error: function(error) {
                                console.error("Error attaching plugin...", error);
                                updateStatus("Error attaching plugin.");
                            },
                            onmessage: function(msg, jsep) {
                                console.log("Received message from Janus:", msg);

                                var event = msg["videoroom"];
                                if (event) {
                                    if (event === "created") {
                                        updateStatus("Room created successfully. Ready to join.");
                                    } else if (event === "joined") {
                                        isPublisher = true;
                                        updateStatus("Successfully joined the room.");
                                        videoRoomPlugin.createOffer({
                                            media: { audio: true, video: true, data: false },
                                            success: function(jsep) {
                                                let publish = { request: "publish", audio: true, video: true };
                                                videoRoomPlugin.send({ message: publish, jsep: jsep });
                                                console.log("Successfully offer.");

                                            },
                                            error: function(error) {
                                                console.error("WebRTC error:", error);
                                                updateStatus("WebRTC error.");
                                            }
                                        });
                                    } else if (event === "event") {
                                        console.log("process event, current msg: ", msg);
                                        if (msg["publishers"]) {
                                            var list = msg["publishers"];
                                            for (var f in list) {
                                                var id = list[f]["id"];
                                                let subscribe = { request: "join", room: myRoom, ptype: "subscriber", feed: id };
                                                videoRoomPlugin.send({ message: subscribe });
                                                console.log("Successfully subscribe.");
                                            }
                                        } else if (msg["leaving"]) {
                                            let id = msg["leaving"];
                                            console.log("Publisher left:", id);
                                            // Handle publisher leaving (e.g., remove their video element)
                                        }
                                    }
                                }
                                if (jsep) {
                                    videoRoomPlugin.handleRemoteJsep({ jsep: jsep });
                                }
                            },
                            onlocalstream: function(stream) {
                                Janus.attachMediaStream(document.getElementById("localVideo"), stream);
                                updateStatus("Local stream started.");
                            },
                            onremotestream: function(stream) {
                                console.log("Remote stream received:", stream);
                                // Create a new video element for the remote participant
                                let remoteVideo = document.createElement("video");
                                remoteVideo.autoplay = true;
                                remoteVideo.style.width = "320px";
                                remoteVideo.style.height = "240px";
                                document.getElementById("remoteVideos").appendChild(remoteVideo);
                                Janus.attachMediaStream(remoteVideo, stream);
                                updateStatus("Remote stream received.");
                            },
                            oncleanup: function() {
                                console.log("Cleanup done.");
                                updateStatus("Cleanup done.");
                            }
                        });
                    },
                    error: function(error) {
                        console.error("Error connecting to Janus:", error);
                        updateStatus("Error connecting to Janus.");
                    }
                });
            }
        });

        document.getElementById("createRoom").addEventListener("click", function() {
            let createRoom = {
                request: "create",
                room: myRoom,
                description: "Test Video Room",
                publishers: 6
            };
            videoRoomPlugin.send({ message: createRoom });
            updateStatus("Creating room...");

            // videoRoomPlugin.data({
            //     text: JSON.stringify(createRoom),
            //     error: function(error){
            //         console.log(error);
            //     }
            // })
        });

        document.getElementById("joinRoom").addEventListener("click", function() {
            if (isPublisher) {
                console.log("Already joined as a publisher.");
                updateStatus("Already joined as a publisher.");
                return;
            }
            let register = {
                request: "join",
                room: myRoom,
                ptype: "publisher",
                display: "MyDisplayName"
            };
            videoRoomPlugin.send({ message: register });
            updateStatus("Joining room...");
        });
    </script>
</body>
</html>
