<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janus AudioBridge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.2.3/adapter.min.js"></script>
    <script type="text/javascript" src="janus.js"></script>
</head>
<body>
    <h1>Janus AudioBridge Example</h1>
    <button id="join">Join Audio Room</button>
    <button id="leave" disabled>Leave Audio Room</button>

    <audio id="remoteAudio" autoplay playsinline></audio>
    <script>
        let server = "ws://125.212.229.11:8188/ws";  // Your Janus server URL
        let janus = null;
        let audiobridge = null;
        let opaqueId = "audiobridgetest-" + Janus.randomString(12);
        let room = 1234;  // Room ID
        let username = "User_" + Math.floor(Math.random() * 1000);
        var myid = null;
        var webrtcUp = false;

        // Initialize Janus
        Janus.init({
            debug: "all", 
            callback: function() {
                $('#join').one('click', joinAudioRoom);
            }
        });

        function joinAudioRoom() {
            janus = new Janus({
                server: server,
                success: function() {
                    // Attach to AudioBridge plugin
                    janus.attach({
                        plugin: "janus.plugin.audiobridge",
                        opaqueId: opaqueId,
                        success: function(pluginHandle) {
                            audiobridge = pluginHandle;
                            console.log("Plugin attached! (" + audiobridge.getPlugin() + ", id=" + audiobridge.getId() + ")");

                            // Join the audio room
                            let register = {
                                request: "join",
                                room: room,
                                display: username
                            };
                            audiobridge.send({ message: register });

                            // Enable leave button
                            $('#leave').prop('disabled', false).one('click', leaveAudioRoom);
                        },
                        error: function(error) {
                            console.error("Error attaching plugin...", error);
                        },
                        onmessage: function(msg, jsep) {
                            let event = msg["audiobridge"];
                            console.log("Got a message:", msg);
                            if(event) {
                                if(event === "joined") {
                                    // Successfully joined, negotiate WebRTC now
                                    if(msg["id"]) {
                                        myid = msg["id"];

                                        console.log("Successfully joined room " + msg["room"]);
                                        // Handle JSEP if provided
                                        if(!webrtcUp) {
                                            webrtcUp = true;
                                            // Publish our stream
                                            audiobridge.createOffer({
                                                // We only want bidirectional audio
                                                tracks: [
                                                    { type: 'audio', capture: true, recv: true },
                                                ],
                                                // customizeSdp: function(jsep) {
                                                //     if(stereo && jsep.sdp.indexOf("stereo=1") == -1) {
                                                //         // Make sure that our offer contains stereo too
                                                //         jsep.sdp = jsep.sdp.replace("useinbandfec=1", "useinbandfec=1;stereo=1");
                                                //         // Create a spinner waiting for the remote video
                                                //         $('#mixedaudio').html(
                                                //             '<div class="text-center">' +
                                                //             '	<div id="spinner" class="spinner-border" role="status">' +
                                                //             '		<span class="visually-hidden">Loading...</span>' +
                                                //             '	</div>' +
                                                //             '</div>');
                                                //     }
                                                // },
                                                success: function(jsep) {
                                                    Janus.debug("Got SDP!", jsep);
                                                    let publish = { request: "configure", muted: false };
                                                    mixertest.send({ message: publish, jsep: jsep });
                                                },
                                                error: function(error) {
                                                    Janus.error("WebRTC error:", error);
                                                    bootbox.alert("WebRTC error... " + error.message);
                                                }
                                            });
                                        }
                                    }
                                }
                            }
                        },
                        onlocaltrack: function(track) {
                            // Handle local audio stream (your microphone)
                            console.log("Got local track:", track);
                        },
                        onremotetrack: function(track) {
                            // Handle remote audio streams (other participants)
                            console.log("Got remote track:", track);
                            let stream = new MediaStream([track]);
                            Janus.attachMediaStream(document.getElementById("remoteAudio"), stream);

                        },
                        oncleanup: function() {
                            console.log("Cleaning up...");
                        }
                    });
                },
                error: function(error) {
                    console.error("Error initializing Janus:", error);
                },
                destroyed: function() {
                    console.log("Janus instance destroyed");
                }
            });
        }

        function leaveAudioRoom() {
            let leave = { request: "leave" };
            audiobridge.send({ message: leave });
            janus.destroy();
            $('#leave').prop('disabled', true);
            $('#join').prop('disabled', false).one('click', joinAudioRoom);
        }
    </script>
</body>
</html>
